<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>주소로 장소 표시하기</title>
    <style>
        #map {
            width : 100%;
            height : 1070px;
        }
    </style>
</head>
<body>
    <button onclick="Home()">HOME</button>
    <div id="map"></div>
<script type="text/javascript" src="js/jquery-3.4.1.min.js"></script>
<script type="text/javascript"src="//dapi.kakao.com/v2/maps/sdk.js?appkey=d30b430fc168d024cbfef307b239c005&libraries=services"></script>
<script>

var centerCoordinate = {
    x : 37.54421633484558,
    y : 126.97017197882703
};

var polygons=[];
var markers=[];
var selectCenter;

var mapInfo;

$.ajax({ 
    url: "resources/json/MapInfo.json", 
    dataType: 'json', 
    async: false, 
    success: function(json){ 
        mapInfo = json;   
    } 
});
/*
var mapInfo = {
    서울특별시 : {
        zoomlevel : 9,
        cameraInfo : [
            {
                name : '상암',
                url  : 'http://211.181.145.26:7080/gQDmTZGWixjPRKqxS9zt0E/YWzX4t7wcX44mhXgCJdM=.m3u8',
                x  : 37.57921742953529,
                y  : 126.89223322735533
            },
            {
                name : '공덕',
                url  : 'http://211.181.145.26:7080/aW60Wd8JxAEPq9iUxLCAxuWApvqAMoNtqc4WdNaD2qE=.m3u8',
                x  : 37.54353684803795,
                y  : 126.95199667222542
            }
        ]
    },
    경기도 : {
        zoomlevel : 10,
        cameraInfo : [
           
        ]
    },
    강원도 : {
        zoomlevel : 10,
        cameraInfo : [
           
        ]
    },
    경상남도 : {
        zoomlevel : 10,
        cameraInfo : [
           
        ]
    },
    경상북도 : {
        zoomlevel : 10,
        cameraInfo : [
           
        ]
    },
    광주광역시 : {
        zoomlevel : 10,
        cameraInfo : [
           
        ]
    },
    대구광역시 : {
        zoomlevel : 10,
        cameraInfo : [
           
        ]
    },
    대전광역시 : {
        zoomlevel : 10,
        cameraInfo : [
           
        ]
    },
    부산광역시 : {
        zoomlevel : 10,
        cameraInfo : [
           
        ]
    },
    울산광역시 : {
        zoomlevel : 10,
        cameraInfo : [
           
        ]
    },
    인천광역시 : {
        zoomlevel : 10,
        cameraInfo : [
           
        ]
    },
    전라남도 : {
        zoomlevel : 10,
        cameraInfo : [
           
        ]
    },
    전라북도 : {
        zoomlevel : 10,
        cameraInfo : [
           
        ]
    },
    제주특별자치도 : {
        zoomlevel : 10,
        cameraInfo : [
           
        ]
    },
    충청남도 : {
        zoomlevel : 10,
        cameraInfo : [
           
        ]
    },
    충청북도 : {
        zoomlevel : 10,
        cameraInfo : [
           
        ]
    },
    세종특별자치시 : {
        zoomlevel : 8,
        cameraInfo : [
            {
                name : '세종대학병원',
                url  : 'http://211.181.145.26:7080/gQDmTZGWixjPRKqxS9zt0E/YWzX4t7wcX44mhXgCJdM=.m3u8',
                x  : 36.5183994078192,
                y  : 127.25825335440359
            },
            {
                name : '세종시청',
                url  : 'http://211.181.145.26:7080/aW60Wd8JxAEPq9iUxLCAxuWApvqAMoNtqc4WdNaD2qE=.m3u8',
                x  : 36.4799743878589,
                y  : 127.28954928364432
            }
        ]
    }
};
*/
var mapContainer = document.getElementById('map'), // 지도를 표시할 div 
    mapOption = {
        center: new kakao.maps.LatLng(centerCoordinate.x,centerCoordinate.y), // 지도의 중심좌표
        level: 12 // 지도의 확대 레벨
    };  

// 지도를 생성합니다    
var map = new kakao.maps.Map(mapContainer, mapOption); 

//행정구역 구분
$.getJSON("resources/json/CTPRVN.json", function(geojson) {
 
    var data = geojson.features;
    var coordinates = [];    //좌표 저장할 배열
    var name = '';            //행정 구 이름
 
    $.each(data, function(index, val) {
 
        coordinates = val.geometry.coordinates;
        name = val.properties.CTP_KOR_NM;

		if( val.geometry.type == "Polygon" )
		{
			displayArea(coordinates, name);
		}
		else
		{
			for( i =0; i<coordinates.length;i++)
			{
				var object = coordinates[i]; 
                displayArea(object, name);
			}
		}
    })
});

insertMarker();

//행정구역 폴리곤
function displayArea(coordinates, name) {

    var path = [];            //폴리곤 그려줄 path
    var points = [];        //중심좌표 구하기 위한 지역구 좌표들
    
    $.each(coordinates[0], function(index, coordinate) {        //console.log(coordinates)를 확인해보면 보면 [0]번째에 배열이 주로 저장이 됨.  그래서 [0]번째 배열에서 꺼내줌.
        var point = new Object(); 
        point.x = coordinate[1];
        point.y = coordinate[0];
        points.push(point);
        path.push(new kakao.maps.LatLng(coordinate[1], coordinate[0]));            //new daum.maps.LatLng가 없으면 인식을 못해서 path 배열에 추가
    })
    
    // 다각형을 생성합니다 
    var polygon = new kakao.maps.Polygon({
        map : map, // 다각형을 표시할 지도 객체
        path : path,
        strokeWeight : 2,
        strokeColor : '#004c80',
        strokeOpacity : 0.8,
        fillColor : '#fff',
        fillOpacity : 0.7,
    });

    polygon.name = name;

    polygons.push(polygon);            //폴리곤 제거하기 위한 배열
	 
    // 다각형에 mouseover 이벤트를 등록하고 이벤트가 발생하면 폴리곤의 채움색을 변경합니다 
    // 지역명을 표시하는 커스텀오버레이를 지도위에 표시합니다
    kakao.maps.event.addListener(polygon, 'mouseover', function(mouseEvent) {
        polygon.setOptions({
            fillColor : '#09f'
        });

    });
 
    // 다각형에 mousemove 이벤트를 등록하고 이벤트가 발생하면 커스텀 오버레이의 위치를 변경합니다 
    kakao.maps.event.addListener(polygon, 'mousemove', function(mouseEvent) {
 
    });
 
    // 다각형에 mouseout 이벤트를 등록하고 이벤트가 발생하면 폴리곤의 채움색을 원래색으로 변경합니다
    // 커스텀 오버레이를 지도에서 제거합니다 
    kakao.maps.event.addListener(polygon, 'mouseout', function() {
        polygon.setOptions({
            fillColor : '#fff'
        });
    });
 
    // 다각형에 click 이벤트를 등록하고 이벤트가 발생하면 해당 지역 확대을 확대합니다.
    kakao.maps.event.addListener(polygon, 'click', function() {
        var level = mapInfo[polygon.name].zoomlevel;
        var center = centroid(points);
        selectCenter = center;
        
        visibleMarker('',false);
        visibleMarker(polygon.name,true);

        if( map.getLevel() == level )
        {
            map.panTo(selectCenter);
        }
        else{
             // 지도를 클릭된 폴리곤의 중앙 위치를 기준으로 확대합니다
            map.setLevel(level, {anchor: center, animate: {
                duration: 350            //확대 애니메이션 시간
            }});  
        }
                 
		polygon.setOptions({
            fillColor : '#fff'
        });

    });
}

kakao.maps.event.addListener(map, 'zoom_changed', function() {
    map.panTo(selectCenter);
})

function insertMarker(){
    for(var sidoName in mapInfo)
    {
        markers[sidoName] = [];
        for(var iter in mapInfo[sidoName]['cameraInfo'])
        {
            var camera = mapInfo[sidoName]['cameraInfo'][iter];

            var imageSrc = './image/camera_68.png';
            var imageSize = new kakao.maps.Size(64, 64);
            var imageOption = {offset: new kakao.maps.Point(27, 69)};

            var markerImage = new kakao.maps.MarkerImage(imageSrc, imageSize, imageOption);
            var markerPosition = new kakao.maps.LatLng(camera.x, camera.y);

            var marker = new kakao.maps.Marker({
                position: markerPosition,
                image: markerImage // 마커이미지 설정 
            });

            marker.camera = camera;

            kakao.maps.event.addListener(marker, 'click', function() {
                alert(marker.camera.name);
            });

            
            marker.setMap(map);
            marker.setVisible(false);
            markers[sidoName ].push(marker);
        }
    }
}

function visibleMarker(sidoName , bVisible)
{
    if( sidoName == '' )
    {
        for( var sido in markers)
        {
            var sidoList = markers[sido];
            for(var i=0;i<sidoList.length;i++)
            {
                sidoList[i].setVisible(bVisible);
            }
        }
    }
    else
    {
        var sidoList = markers[sidoName];
        if( sidoList == null )
            return;
        for(var i=0;i<sidoList.length;i++)
        {
            sidoList[i].setVisible(bVisible);
        }
    }
}

function Home()
{
    selectCenter = new kakao.maps.LatLng(centerCoordinate.x, centerCoordinate.y);        
    map.setLevel(12, {anchor: selectCenter, animate: {
                duration: 350            //확대 애니메이션 시간
    }}); 

    visibleMarker("",false);
}

//마커를 모두 삭제하자.
function deletePolygon(polygons) {
    for (var i = 0; i < polygons.length; i++) {
        polygons[i].setMap(null);
    }

    polygons.deleteMarker();
}

//centroid 알고리즘 (폴리곤 중심좌표 구하기 위함)
function centroid (points) {
    var i, j, len, p1, p2, f, area, x, y;
 
    area = x = y = 0;
 
    for (i = 0, len = points.length, j = len - 1; i < len; j = i++) {
            p1 = points[i];
            p2 = points[j];
 
            f = p1.y * p2.x - p2.y * p1.x;
            x += (p1.x + p2.x) * f;
            y += (p1.y + p2.y) * f;
            area += f * 3;
    }
    return new kakao.maps.LatLng(x / area, y / area);
}

</script>
</body>
</html>