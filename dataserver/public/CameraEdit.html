<!DOCTYPE html>
<html lang="en">

<head>
    <link rel="stylesheet" href="https://unpkg.com/ag-grid-community/dist/styles/ag-grid.css">
    <link rel="stylesheet" href="https://unpkg.com/ag-grid-community/dist/styles/ag-theme-alpine.css">
    <link href="css/cameraedit.css" rel="stylesheet" />

    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <title>YTN 지도 터치 CCTV 카메라 편집</title>

    <script type="text/javascript" src="js/jquery-3.4.1.min.js"></script>
    <script src="https://unpkg.com/ag-grid-community/dist/ag-grid-community.min.noStyle.js"></script>
    <script src="https://unpkg.com/ag-grid-community/dist/ag-grid-community.min.js"></script>
    <script type="text/javascript" charset="utf-8">
        var mapdataServer = '';
        var mapInfo;
        var agrid;
        var DBdata;
        var selectedDBdata = {
            id: undefined,
            name: "",
            cameralist: []
        };

        var onairname = "방송용";

        // 칼럼정의
        var columnDefs = [{
            headerName: "시도",
            field: "sidoname",
            sortable: true,
            editable: true,
            filter: true,
            checkboxSelection: true
        }, {
            headerName: "이름",
            field: "name",
            sortable: true,
            editable: true,
            filter: true
        }, {
            headerName: "url",
            field: "url",
            sortable: true,
            editable: true,
            filter: true,
            flex: 1
        }, {
            headerName: "위도",
            field: "lan",
            sortable: true,
            editable: true,
            filter: true
        }, {
            headerName: "경도",
            field: "lon",
            sortable: true,
            editable: true,
            filter: true
        }, {
            headerName: "visible",
            field: "visible",
            sortable: true,
            editable: true,
            filter: true,
            type: Boolean
        }];

        columnDefs[0].cellEditor = 'agSelectCellEditor';
        columnDefs[0].cellEditorParams = {
            values: ['서울특별시', '경기도', '강원도', '경상남도', '경상북도', '광주광역시', '대구광역시', '대전광역시', '부산광역시', '울산광역시', '인천광역시', '전라남도', '전라북도', '제주특별자치도', '충청남도', '충청북도', '세종특별자치시']
        }

        columnDefs[5].cellEditor = 'agSelectCellEditor';
        columnDefs[5].cellEditorParams = {
            values: [true, false]
        }

        var gridOptions = {
            columnDefs: columnDefs,
            rowSelection: 'multiple',
            domLayout: 'autoHeight',
        };

        $(document).ready(function() {
            var eGridDiv = document.querySelector('#myGrid');
            agrid = new agGrid.Grid(eGridDiv, gridOptions);

            UpdateMapNames();
            gridOptions.api.setRowData(selectedDBdata.cameralist); // 데이터 초기화

            // 맵데이터를 선택하면 해당 데이터를 가져와서 그리드에 뿌려줌
            $('#mapcombobox')
                .on('change', function(e) {
                    // 선택 메뉴가 맵선택이면 새리스트
                    if (this.value === "맵선택") {
                        selectedDBdata = {
                            id: undefined,
                            name: "",
                            cameralist: []
                        };
                        gridOptions.api.setRowData(selectedDBdata.cameralist);
                        return;
                    }

                    selectedDBdata = GetSelectedMapFromDB(this.value);
                    agrid.gridOptions.api.setRowData(selectedDBdata.cameralist);
                });
        })

        function UpdateMapNames() {
            let maplist = GetAllMapNamesFromDB();

            var select = document.getElementById("mapcombobox");
            $('#mapcombobox option').remove();
            var option = document.createElement('option');
            option.value = option.text = "맵선택";
            select.appendChild(option);

            maplist.forEach(element => {
                option = document.createElement('option');
                option.value = option.text = element.name;
                select.appendChild(option);
            });
        }

        function ShowMapDataFromJson() {
            var eGridDiv = document.querySelector('#myGrid');
            agrid = new agGrid.Grid(eGridDiv, gridOptions);

            agGrid
                .simpleHttpRequest({
                    url: 'resources/json/MapInfo.json'
                })
                .then(function(data) {
                    MakeCameraDataListFromMapInfo(data);
                    gridOptions.api.setRowData(rowData);
                });
        }

        function getZoomLevel(sidoname) {
            let zoomlevel = {
                "서울특별시": 9,
                "경기도": 11,
                "강원도": 11,
                "경상남도": 11,
                "경상북도": 11,
                "광주광역시": 10,
                "대구광역시": 10,
                "대전광역시": 9,
                "부산광역시": 9,
                "울산광역시": 9,
                "인천광역시": 9,
                "전라남도": 11,
                "전라북도": 10,
                "제주특별자치도": 9,
                "충청남도": 10,
                "충청북도": 11,
                "세종특별자치시": 9
            };
            return zoomlevel[sidoname];
        }

        function onAddCamera() {
            let newRow = {
                name: "",
                url: "",
                lan: 0,
                lon: 0,
                visible: true,
                sidocode: 1,
                sidoname: "서울특별시"
            };
            selectedDBdata.cameralist.push(newRow);
            gridOptions.api.setRowData(selectedDBdata.cameralist);
        }

        function onDeleteCamera() {
            var selectedRows = gridOptions.api.getSelectedNodes();
            if (!selectedRows || selectedRows.length === 0) {
                return;
            }

            selectedRows.reverse().forEach(function(selectedRow) {
                selectedDBdata.cameralist.splice(selectedRow.rowIndex, 1);
            });

            gridOptions.api.setRowData(selectedDBdata.cameralist);
        }

        function onDeleteData() {
            DeleteMapOnDB();
        }

        function onSaveData() {
            // id가 없으면 새로 저장 
            if (selectedDBdata.id === undefined) {
                // 새리스트인 경우
                // 새맵이름이 없으면 새맵이름을 입력하도록 커서를 옮겨줌
                if ($('#newname').val() === undefined) {
                    $('#newname').focus();
                } else { // 이름 있으면 새이름으로 저장
                    SaveNewMapOnDB();
                }
            } else { // 아니면 id로 저장
                UpdateMapOnDB();
            }
        }

        function onSaveNewData() {
            // 새맵 저장            
            SaveNewMapOnDB();
        }

        // 방송용 맵 확인
        function onShowOnairData() {
            selectedDBdata = GetSelectedMapFromDB(onairname);
            agrid.gridOptions.api.setRowData(selectedDBdata.cameralist);
        }

        // 방송용 맵 저장
        function onSaveOnairData() {
            SaveOnairMaptoDB();
        }

        // 해당 이름의 맵데이터 가져오기
        function GetSelectedMapFromDB(mapname) {
            var selectedmapdata;
            $.ajax({
                type: "GET",
                contentType: "application/json;charset=utf-8",
                url: mapdataServer + "/cameralist?filter={\"where\": {\"name\": \"" + mapname + "\"}}",
                dataType: 'json',
                async: false,
                success: function(data) {
                    selectedmapdata = data[0];
                }
            });
            return selectedmapdata;
        }

        // 새 맵 데이터 저장
        function SaveNewMapOnDB() {
            selectedDBdata = {
                name: $('#newname').val(),
                cameralist: selectedDBdata.cameralist
            }

            $.ajax({
                type: "POST",
                contentType: "application/json;charset=utf-8",
                url: mapdataServer + "/cameralist",
                data: JSON.stringify(selectedDBdata),
                dataType: 'json'
            });
        }

        // 맵데이터 업데이트
        function UpdateMapOnDB() {
            if (selectedDBdata.id === undefined) {
                return;
            }

            $.ajax({
                type: "PATCH",
                contentType: "application/json;charset=utf-8",
                url: mapdataServer + "/cameralist/" + selectedDBdata.id,
                data: JSON.stringify(selectedDBdata),
                dataType: 'json'
            });
        }

        // 맵데이터 삭제
        function DeleteMapOnDB() {
            if (selectedDBdata.id === undefined) {
                return;
            }

            $.ajax({
                type: "DELETE",
                contentType: "application/json;charset=utf-8",
                url: mapdataServer + "/cameralist/" + selectedDBdata.id,
                dataType: 'json'
            });
        }

        // 맵이름 다 가져오기
        function GetAllMapNamesFromDB() {
            var mapnames = [];
            $.ajax({
                type: "GET",
                url: mapdataServer + "//cameralist?filter={\"fields\":{\"name\":true}}",
                dataType: 'json',
                async: false,
                success: function(maps) {
                    mapnames = maps;
                }
            });
            return mapnames;
        }

        // 방송용 맵 저장
        function SaveOnairMaptoDB() {
            // 아이템이 없으면 아웃
            if (selectedDBdata.cameralist.length === 0) {
                return;
            }
            // 방송용 이름 맵 찾기
            var onairmaps = [];
            $.ajax({
                type: "GET",
                url: mapdataServer + "/cameralist?filter={\"where\": {\"name\": \"" + onairname + "\"}}",
                dataType: 'json',
                async: false,
                success: function(maps) {
                    onairmaps = maps;
                }
            });

            // 지우기
            onairmaps.forEach(element => {
                $.ajax({
                    type: "DELETE",
                    contentType: "application/json;charset=utf-8",
                    url: mapdataServer + "/cameralist/" + element.id,
                    dataType: 'json'
                });
            });

            // 선택된 아이템으로 방송용 아이템으로 만들기
            let onairmap = {
                name: onairname,
                cameralist: selectedDBdata.cameralist
            }

            // 방송용 이름으로 저장
            $.ajax({
                type: "POST",
                contentType: "application/json;charset=utf-8",
                url: mapdataServer + "/cameralist",
                data: JSON.stringify(onairmap),
                dataType: 'json'
            });
        }
    </script>
</head>

<body>
    <header>
        <div class="buttons">
            <div class="leftbuttons">
                <button id="addItem" class="topitem" onclick="onAddCamera()">Add Camera</button>
                <button id="deleteItem" class="topitem" onclick="onDeleteCamera()">Delete Camera</button>

                <select name="maplist" id="mapcombobox" class="topitem">
                    <option value="">맵선택</option>
                </select>
                <button id="deleteData" class="topitem" onclick="onDeleteData()">맵 삭제</button>
                <button id="saveData" class="topitem" onclick="onSaveData()">맵 저장</button>

                <form id="newfilenameform">
                    <input type="text" id="newname" class="topitem cursor rq-form-element" placeholder="새 맵 이름">
                    <button id="saveNewData" class="topitem" onclick="onSaveNewData()">새 맵으로 저장</button>
                </form>

            </div>
            <div class="rightbuttons">
                <button id="showOnairData" class="topitem" onclick="onShowOnairData()">방송맵 확인</button>
                <button id="saveOnairData" class="topitem" onclick="onSaveOnairData()">방송맵 저장</button>
            </div>
        </div>
    </header>

    <main>
        <div id="myGrid" class="ag-theme-alpine"></div>
    </main>
</body>

</html>