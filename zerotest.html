<!DOCTYPE html>
<html>

<head>
    <link href="css/styles.css" rel="stylesheet" />
    <meta charset="utf-8">
    <title>주소로 장소 표시하기</title>
</head>

<body>
    <div id="map" style="width:100%;height:1070px;"></div>
    <script type="text/javascript" src="js/jquery-3.4.1.min.js"></script>
    <script type="text/javascript" src="//dapi.kakao.com/v2/maps/sdk.js?appkey=d30b430fc168d024cbfef307b239c005&libraries=services"></script>
    <script>
        $(document).ready(function() {
            $('#home')
                .on('touchstart click', function(e) {
                    e.preventDefault();

                    // 현재 지도의 레벨을 얻어옵니다
                    var level = map.getLevel();
                    // 지도를 초기레벨로 셋팅합니다
                    map.setLevel(initmaplevel);
                    // 지도 레벨을 표시합니다
                    displayLevel();
                });
        })

        var initmaplevel = 13;
        var mapContainer = document.getElementById('map'), // 지도를 표시할 div 
            mapOption = {
                center: new kakao.maps.LatLng(36.6429912198493, 127.903045504223), // 지도의 중심좌표
                level: initmaplevel // 지도의 확대 레벨
            };

        // 지도를 생성합니다    
        var map = new kakao.maps.Map(mapContainer, mapOption);


        // 주소-좌표 변환 객체를 생성합니다
        var geocoder = new kakao.maps.services.Geocoder();
        /*
        // 주소로 좌표를 검색합니다
        geocoder.addressSearch('서울시', function(result, status) {

            // 정상적으로 검색이 완료됐으면 
             if (status === kakao.maps.services.Status.OK) {

                var coords = new kakao.maps.LatLng(result[0].y, result[0].x);

                // 결과값으로 받은 위치를 마커로 표시합니다
                var marker = new kakao.maps.Marker({
                    map: map,
                    position: coords
                });

                // 인포윈도우로 장소에 대한 설명을 표시합니다
                var infowindow = new kakao.maps.InfoWindow({
                    content: '<div style="width:150px;text-align:center;padding:6px 0;">YTN</div>'
                });
                infowindow.open(map, marker);

                // 지도의 중심을 결과값으로 받은 위치로 이동시킵니다
                //map.setCenter(coords);
            } 
        });*/

        //행정구역 구분
        $.getJSON("resources/json/CTPRVN.json", function(geojson) {

            var data = geojson.features;
            var coordinates = []; //좌표 저장할 배열
            var name = ''; //행정 구 이름

            $.each(data, function(index, val) {

                coordinates = val.geometry.coordinates;
                name = val.properties.CTP_KOR_NM;

                if (val.geometry.type == "Polygon") {
                    displayArea(coordinates, name);
                } else {
                    for (i = 0; i < coordinates.length; i++) {
                        var object = coordinates[i];
                        displayArea(object, name);
                    }
                }
            })
        });

        var polygons = [];
        var selectCenter;

        //행정구역 폴리곤
        function displayArea(coordinates, name) {

            var path = []; //폴리곤 그려줄 path
            var points = []; //중심좌표 구하기 위한 지역구 좌표들

            $.each(coordinates[0], function(index, coordinate) { //console.log(coordinates)를 확인해보면 보면 [0]번째에 배열이 주로 저장이 됨.  그래서 [0]번째 배열에서 꺼내줌.
                var point = new Object();
                point.x = coordinate[1];
                point.y = coordinate[0];
                points.push(point);
                path.push(new kakao.maps.LatLng(coordinate[1], coordinate[0])); //new daum.maps.LatLng가 없으면 인식을 못해서 path 배열에 추가
            })

            // 다각형을 생성합니다 
            var polygon = new kakao.maps.Polygon({
                map: map, // 다각형을 표시할 지도 객체
                path: path,
                strokeWeight: 2,
                strokeColor: '#004c80',
                strokeOpacity: 0.8,
                fillColor: '#fff',
                fillOpacity: 0.7,
            });

            polygons.push(polygon); //폴리곤 제거하기 위한 배열

            // 다각형에 mouseover 이벤트를 등록하고 이벤트가 발생하면 폴리곤의 채움색을 변경합니다 
            // 지역명을 표시하는 커스텀오버레이를 지도위에 표시합니다
            kakao.maps.event.addListener(polygon, 'mouseover', function(mouseEvent) {
                polygon.setOptions({
                    fillColor: '#09f'
                });

            });

            // 다각형에 mousemove 이벤트를 등록하고 이벤트가 발생하면 커스텀 오버레이의 위치를 변경합니다 
            kakao.maps.event.addListener(polygon, 'mousemove', function(mouseEvent) {

            });

            // 다각형에 mouseout 이벤트를 등록하고 이벤트가 발생하면 폴리곤의 채움색을 원래색으로 변경합니다
            // 커스텀 오버레이를 지도에서 제거합니다 
            kakao.maps.event.addListener(polygon, 'mouseout', function() {
                polygon.setOptions({
                    fillColor: '#fff'
                });
            });

            // 다각형에 click 이벤트를 등록하고 이벤트가 발생하면 해당 지역 확대을 확대합니다.
            kakao.maps.event.addListener(polygon, 'click', function() {

                var level = 10;

                var center = centroid(points);

                selectCenter = center;

                if (map.getLevel() == 10) {
                    map.panTo(selectCenter);
                } else {
                    // 지도를 클릭된 폴리곤의 중앙 위치를 기준으로 확대합니다
                    map.setLevel(level, {
                        anchor: center,
                        animate: {
                            duration: 350 //확대 애니메이션 시간
                        }
                    });
                }

                polygon.setOptions({
                    fillColor: '#fff'
                });

            });
        }


        kakao.maps.event.addListener(map, 'bounds_changed', function() {
            map.panTo(selectCenter);
            /*
                geocoder.addressSearch(selectName, function(result, status) {
                    // 정상적으로 검색이 완료됐으면 
                    if (status === kakao.maps.services.Status.OK) {

                        var coords = new kakao.maps.LatLng(result[0].y, result[0].x);

                        // 결과값으로 받은 위치를 마커로 표시합니다
                        var marker = new kakao.maps.Marker({
                            map: map,
                            position: coords
                        });

                        // 인포윈도우로 장소에 대한 설명을 표시합니다
                        var infowindow = new kakao.maps.InfoWindow({
                            content: '<div style="width:150px;text-align:center;padding:6px 0;">YTN</div>'
                        });
                        infowindow.open(map, marker);

                        // 지도의 중심을 결과값으로 받은 위치로 이동시킵니다
                        //map.setCenter(coords);
                    } 
                });*/
        })

        //지도 위 표시되고 있는 폴리곤 제거
        function deletePolygon(polygons) {
            for (var i = 0; i < polygons.length; i++) {
                polygons[i].setMap(null);
            }
            polygons = [];
        }

        //centroid 알고리즘 (폴리곤 중심좌표 구하기 위함)
        function centroid(points) {
            var i, j, len, p1, p2, f, area, x, y;

            area = x = y = 0;

            for (i = 0, len = points.length, j = len - 1; i < len; j = i++) {
                p1 = points[i];
                p2 = points[j];

                f = p1.y * p2.x - p2.y * p1.x;
                x += (p1.x + p2.x) * f;
                y += (p1.y + p2.y) * f;
                area += f * 3;
            }
            return new kakao.maps.LatLng(x / area, y / area);
        }
    </script>
    <aside class="menu">
        <img id="home" src="/image/map.png" alt="home image" srcset="/image/map.svg">
    </aside>
</body>

</html>