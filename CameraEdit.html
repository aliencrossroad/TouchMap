<!DOCTYPE html>
<html lang="en">

<head>
    <link rel="stylesheet" href="https://unpkg.com/ag-grid-community/dist/styles/ag-grid.css">
    <link rel="stylesheet" href="https://unpkg.com/ag-grid-community/dist/styles/ag-theme-alpine.css">
    <link href="css/cameraedit.css" rel="stylesheet" />

    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <title>YTN 지도 터치 CCTV 카메라 편집</title>

    <script type="text/javascript" src="js/jquery-3.4.1.min.js"></script>
    <script src="https://unpkg.com/ag-grid-community/dist/ag-grid-community.min.noStyle.js"></script>
    <script src="https://unpkg.com/ag-grid-community/dist/ag-grid-community.min.js"></script>
    <script type="text/javascript" charset="utf-8">
        var mapInfo;
        var agrid;

        // 칼럼정의
        var columnDefs = [{
            headerName: "시도",
            field: "sido",
            sortable: true,
            editable: true,
            filter: true,
            checkboxSelection: true
        }, {
            headerName: "이름",
            field: "name",
            sortable: true,
            editable: true,
            filter: true
        }, {
            headerName: "url",
            field: "url",
            sortable: true,
            editable: true,
            filter: true,
            flex: 1
        }, {
            headerName: "위도",
            field: "lan",
            sortable: true,
            editable: true,
            filter: true
        }, {
            headerName: "경도",
            field: "lon",
            sortable: true,
            editable: true,
            filter: true
        }, {
            headerName: "visible",
            field: "visible",
            sortable: true,
            editable: true,
            filter: true,
            type: Boolean
        }];

        columnDefs[0].cellEditor = 'agSelectCellEditor';
        columnDefs[0].cellEditorParams = {
            values: ['서울특별시', '경기도', '강원도', '경상남도', '경상북도', '광주광역시', '대구광역시', '대전광역시', '부산광역시', '울산광역시', '인천광역시', '전라남도', '전라북도', '제주특별자치도', '충청남도', '충청북도', '세종특별자치시']
        }

        columnDefs[5].cellEditor = 'agSelectCellEditor';
        columnDefs[5].cellEditorParams = {
            values: [true, false]
        }

        var rowData = [];

        var gridOptions = {
            columnDefs: columnDefs,
            rowSelection: 'multiple'
        };

        $(document).ready(function() {
            var eGridDiv = document.querySelector('#myGrid');
            agrid = new agGrid.Grid(eGridDiv, gridOptions);

            agGrid
                .simpleHttpRequest({
                    url: 'resources/json/MapInfo.json'
                })
                .then(function(data) {
                    MakeCameraDataListFromMapInfo(data);
                    gridOptions.api.setRowData(rowData);
                });
        })

        function MakeCameraDataListFromMapInfo(data) {
            for (var sidoName in data) {
                for (var iter in data[sidoName]['cameraInfo']) {
                    rowData.push({
                        sido: sidoName,
                        name: data[sidoName]['cameraInfo'][iter].name,
                        url: data[sidoName]['cameraInfo'][iter].url,
                        lan: data[sidoName]['cameraInfo'][iter].lan,
                        lon: data[sidoName]['cameraInfo'][iter].lon,
                        visible: data[sidoName]['cameraInfo'][iter].visible
                    });
                }
            }
        }
    </script>
</head>

<body>
    <div class="buttons">
        <button id="addItem" onclick="onAddCamera()">Add Camera</button>
        <button id="deleteItem" onclick="onDeleteCamera()">Delete Camera</button>
        <button id="saveData" onclick="onSaveData()">Save Data</button>
    </div>
    <div id="myGrid" style="height: 600px; width:100%;" class="ag-theme-alpine"></div>

    <script>
        function onAddCamera() {
            let newRow = {
                sido: "서울특별시",
                name: "",
                url: "",
                lan: 0,
                lon: 0,
                visible: true
            };
            rowData.push(newRow);
            gridOptions.api.setRowData(rowData);
        }

        function onDeleteCamera() {
            var selectedRows = gridOptions.api.getSelectedNodes();
            if (!selectedRows || selectedRows.length === 0) {
                return;
            }

            selectedRows.reverse().forEach(function(selectedRow) {
                rowData.splice(selectedRow.rowIndex, 1);
            });

            gridOptions.api.setRowData(rowData);
        }

        function onSaveData() {
            MakeMapInfoFromCameraDataList(rowData);

            $.ajax({
                type: "POST",
                url: "/js/saveConfig.js",
                data: {
                    mapInfo
                }
            });
        }

        function MakeMapInfoFromCameraDataList(rowData) {
            mapInfo = [];
            rowData.forEach(data => {
                if (mapInfo.includes(data.sido) == false) {
                    mapInfo.push(data.sido);
                    mapInfo[data.sido] = [];
                }

                mapInfo[data.sido].push({
                    "name": data.name,
                    "url": data.url,
                    "lan": data.lan,
                    "lon": data.lon,
                    "visible": data.visible
                });
            });
        }
    </script>
</body>

</html>